# v4.4.4 Changes - Upcoming Charges Display & Debugging

## Issue Reported
Dashboard showing different "upcoming" amounts than transactions page for recurring subscriptions.

## Root Cause Analysis

After reviewing the code, I found that **both pages use identical logic** for calculating upcoming/projected charges:

**Dashboard** (lines 113-120):
```typescript
const projected_spent = (purchases || [])
  .filter(p => {
    if (p.category_id !== cat.id || !p.is_projected) return false
    const purchase_date = parse_local_date(p.date)
    return purchase_date >= today  // ✅ Checks date correctly
  })
```

**Transactions** (lines 159-165):
```typescript
const is_truly_upcoming = (purchase: Purchase) => {
  if (!purchase.is_projected) return false
  const purchase_date = parse_local_date(purchase.date)
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  return purchase_date >= today  // ✅ Same logic
}
```

Both pages:
- Query the same date range (current month)
- Filter for `is_projected = true`
- Check that `date >= today`

## The Real Issue

The dashboard **didn't have a clear display** of total upcoming charges in the summary section. The transactions page has a dedicated "Upcoming (Projected)" card showing:
- Total upcoming amount
- Count of upcoming transactions

The dashboard only showed projected amounts under each category, but no overall total in the summary cards.

## Changes Made

### 1. Added "Upcoming" Summary Card
- Changed grid from 4 to 5 columns
- Added yellow card showing total projected charges
- Matches the design from transactions page
- Makes it easy to compare the two pages

### 2. Added Debug Logging
To help identify any discrepancies, added console logging that shows:
- Total purchases fetched
- Projected purchases count
- Per-category projected details (count, amount, dates)
- Final totals breakdown

### 3. Version Update
- Updated to v4.4.4
- Added version notes describing improvements

## How to Test

1. **Open browser console** (F12)
2. **Go to Dashboard**
   - Look at the new "Upcoming" card (yellow, 3rd from left)
   - Check console logs for `[Dashboard]` entries
   - Note the `total_projected` amount
3. **Go to Transactions page**
   - Look at "Upcoming (Projected)" card (yellow, middle)
   - Note the amount shown
4. **Compare the two amounts** - they should be identical

## Debugging Guide

If amounts still don't match, check the console logs:

```
[Dashboard] Today: 2026-01-08
[Dashboard] Total purchases fetched: 25
[Dashboard] Projected purchases: 8
[Dashboard] Category Subscriptions: {
  projected_count: 3,
  projected_amount: 45.97,
  dates: ['2026-01-15', '2026-01-20', '2026-01-28']
}
[Dashboard] Final Totals: {
  total_spent: 234.56,
  total_projected: 125.97,
  total_with_projected: 360.53,
  category_count: 8,
  categories_with_projected: 3
}
```

Look for:
1. **Date mismatches** - Are some projected purchases dated in the past?
2. **Category assignment** - Are projected purchases assigned to the right categories?
3. **is_projected flag** - Are all recurring expenses properly marked?

## Files Modified

1. `app/dashboard/page.tsx` - Added upcoming card + debug logging
2. `lib/version_notes.ts` - Updated to v4.4.4

## Next Steps

If the issue persists after these changes, we should:
1. Check the database directly for projected purchases
2. Verify the `sync_projected_purchases` function is working correctly
3. Look at the `recurring_expenses` table to ensure they're set up properly
4. Add similar logging to the transactions page for comparison
