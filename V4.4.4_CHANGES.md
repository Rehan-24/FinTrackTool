# v4.4.4 Changes - CRITICAL: Duplicate Recurring Charge Fix

## Issue Reported
**CRITICAL BUG:** Recurring charges were being duplicated every time the page refreshed or when multiple tabs were open.

## Root Cause Analysis

The issue was a **race condition** in the `sync_projected_purchases` function:

### The Problem Flow:
1. Page loads → calls `sync_projected_purchases()`
2. Function deletes all future projected purchases
3. Function generates new projected purchases
4. Function inserts the new purchases
5. **If page refreshes during steps 2-4, or multiple tabs call this simultaneously:**
   - Tab 1: Deletes projected purchases
   - Tab 2: Deletes projected purchases (finds nothing to delete)
   - Tab 1: Inserts new projected purchases
   - Tab 2: Inserts new projected purchases again → **DUPLICATES!**

### Code Location (lib/recurring-utils.ts):
```typescript
// This delete happens first
await supabase.from('purchases').delete()
  .eq('user_id', user_id)
  .eq('is_projected', true)
  .gte('date', today)
  .lte('date', end_of_month)

// Then insert happens (gap where race condition occurs)
await supabase.from('purchases').insert(future_projected)
```

The gap between delete and insert is where multiple calls create duplicates.

## The Fix

### 1. Database-Level Prevention (REQUIRED)
Added a unique constraint that prevents duplicate projected purchases at the database level:

```sql
CREATE UNIQUE INDEX idx_unique_projected_purchase 
ON public.purchases (user_id, date, description, category_id, is_projected)
WHERE is_projected = TRUE;
```

This ensures that even if the app tries to insert a duplicate, the database will reject it.

### 2. Application-Level Handling
Updated `sync_projected_purchases` to:
- Insert purchases one at a time
- Catch and ignore duplicate errors gracefully
- Log other errors for debugging

```typescript
for (const purchase of future_projected) {
  const { error } = await supabase
    .from('purchases')
    .insert(purchase)
  
  // Ignore duplicate errors (race condition)
  if (error && !error.message.includes('duplicate')) {
    console.error('[Sync] Error:', error)
  }
}
```

### 3. Visual Improvements
Added "Upcoming" card to dashboard so you can easily see if duplicates occur.

## REQUIRED MIGRATION

**YOU MUST RUN THIS SQL IN SUPABASE:**

1. Go to Supabase Dashboard → SQL Editor
2. Open `migration_v4.4.4_unique_projected.sql`
3. Copy and paste the SQL
4. Click "Run"

This adds the unique constraint that prevents duplicates at the database level.

## How to Verify the Fix

### Before Migration:
1. Open your app
2. Look at dashboard "Upcoming" amount
3. Refresh the page
4. Check if "Upcoming" amount doubled → **BUG**

### After Migration:
1. Run the SQL migration
2. Delete all projected purchases from database (optional cleanup):
   ```sql
   DELETE FROM purchases WHERE is_projected = TRUE;
   ```
3. Open your app
4. Note the "Upcoming" amount
5. Refresh the page multiple times
6. "Upcoming" amount should stay the same → **FIXED**

### Test with Multiple Tabs:
1. Open app in Tab 1
2. Open app in Tab 2
3. Both tabs should show same "Upcoming" amount
4. Refresh both tabs
5. Amount should remain consistent

## Files Modified

1. `lib/recurring-utils.ts` - Fixed race condition in sync function
2. `app/dashboard/page.tsx` - Added upcoming card + debug logging
3. `lib/version_notes.ts` - Updated to v4.4.4
4. **NEW:** `migration_v4.4.4_unique_projected.sql` - Database migration

## Technical Details

### Why Individual Inserts?
Using a loop with individual inserts (instead of batch insert) allows the app to:
- Continue if one insert fails due to duplicate
- Not fail the entire batch
- Handle race conditions gracefully

### Why Unique Constraint?
The constraint provides:
- Database-level guarantee (no app bugs can bypass it)
- Atomic operation (no race conditions possible)
- Automatic prevention (works even if sync is called 100 times)

### Performance Impact
Minimal - projected purchases are typically < 10 per month, so individual inserts are fine.

## Troubleshooting

### "Still seeing duplicates after migration"
1. Verify migration ran successfully in Supabase
2. Check that you have `idx_unique_projected_purchase` index:
   ```sql
   SELECT * FROM pg_indexes WHERE indexname = 'idx_unique_projected_purchase';
   ```
3. Clear all projected purchases and let app regenerate:
   ```sql
   DELETE FROM purchases WHERE is_projected = TRUE;
   ```

### "Console shows errors about duplicates"
This is normal! The app now catches duplicate errors gracefully. You'll see:
```
[Sync] Error: duplicate key value violates unique constraint
```
But the page will work fine - this means the fix is working.

### "How do I remove debug logs?"
Once you verify everything works, edit `app/dashboard/page.tsx` and remove the `console.log` statements (lines ~105-140).

## Next Steps

After deploying v4.4.4:
1. Run the migration SQL
2. Test with multiple tabs
3. Monitor for a few days
4. Remove debug logs if desired
5. Update to v4.4.5 when ready
